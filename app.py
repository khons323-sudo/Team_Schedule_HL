import streamlit as st
import pandas as pd
import plotly.express as px
from streamlit_gsheets import GSheetsConnection
from datetime import datetime

# -----------------------------------------------------------------------------
# 1. í˜ì´ì§€ ì„¤ì • ë° ì œëª©
# -----------------------------------------------------------------------------
st.set_page_config(page_title="ë””ìì¸1ë³¸ë¶€ ì¼ì •ê´€ë¦¬", layout="wide")
st.title("ğŸ“… ë””ìì¸1ë³¸ë¶€ 1íŒ€ ì‘ì—…ì¼ì •")

# -----------------------------------------------------------------------------
# 2. êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„° ì—°ê²° ë° ë¶ˆëŸ¬ì˜¤ê¸°
# -----------------------------------------------------------------------------
# êµ¬ê¸€ ì‹œíŠ¸ ì—°ê²° ê°ì²´ ìƒì„±
conn = st.connection("gsheets", type=GSheetsConnection)

# [ì¤‘ìš”] ttl=0 ì„¤ì •: ìºì‹œë¥¼ ë‚¨ê¸°ì§€ ì•Šê³  ë§¤ë²ˆ ìµœì‹  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. (ì‹¤ì‹œê°„ ê³µìœ  í•µì‹¬)
try:
    data = conn.read(worksheet="Sheet1", usecols=list(range(7)), ttl=0)
except Exception as e:
    st.error(f"ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. êµ¬ê¸€ ì‹œíŠ¸ì˜ íƒ­ ì´ë¦„ì´ 'Sheet1'ì´ ë§ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”. (ì—ëŸ¬: {e})")
    st.stop()

# ë¹ˆ ë°ì´í„°í”„ë ˆì„ ì²˜ë¦¬ (ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° ì»¬ëŸ¼ë§Œ ìƒì„±)
if len(data) == 0:
    data = pd.DataFrame(columns=["í”„ë¡œì íŠ¸ëª…", "í•­ëª©", "ë‹´ë‹¹ì", "Activity", "ì‹œì‘ì¼", "ì¢…ë£Œì¼", "ì§„í–‰ë¥ "])

# -----------------------------------------------------------------------------
# 3. ë°ì´í„° ì „ì²˜ë¦¬ (ë‚ ì§œ ë° ìˆ«ì í˜•ì‹ ê°•ì œ ë³€í™˜)
# -----------------------------------------------------------------------------
# 1) ë‚ ì§œ ì»¬ëŸ¼ì„ ë‚ ì§œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (ì—ëŸ¬ê°€ ë‚˜ë©´ NaTë¡œ ì²˜ë¦¬í•˜ì—¬ í”„ë¡œê·¸ë¨ ë©ˆì¶¤ ë°©ì§€)
data["ì‹œì‘ì¼"] = pd.to_datetime(data["ì‹œì‘ì¼"], errors='coerce')
data["ì¢…ë£Œì¼"] = pd.to_datetime(data["ì¢…ë£Œì¼"], errors='coerce')

# 2) [í•µì‹¬ ìˆ˜ì •] ì§„í–‰ë¥  ì…ë ¥ì´ ì•ˆ ë˜ëŠ” ë¬¸ì œ í•´ê²°
# ì§„í–‰ë¥  ì»¬ëŸ¼ì„ ê°•ì œë¡œ 'ìˆ«ì(ì •ìˆ˜)'ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. ë¹ˆê°’ì´ë‚˜ ë¬¸ìê°€ ìˆìœ¼ë©´ 0ìœ¼ë¡œ ì±„ì›ë‹ˆë‹¤.
data["ì§„í–‰ë¥ "] = pd.to_numeric(data["ì§„í–‰ë¥ "], errors='coerce').fillna(0).astype(int)

# 3) ì°¨íŠ¸ìš© ë°ì´í„° (ë‚ ì§œê°€ ì—†ëŠ” í–‰ì€ ì°¨íŠ¸ì—ì„œ ì œì™¸)
view_data = data.dropna(subset=["ì‹œì‘ì¼", "ì¢…ë£Œì¼"]).copy()

# -----------------------------------------------------------------------------
# 4. [ì…ë ¥ ì„¹ì…˜] ìƒˆë¡œìš´ ì—…ë¬´/ì¼ì • ë“±ë¡ (ê´€ë¦¬ì/íŒ€ì¥ìš©)
# -----------------------------------------------------------------------------
with st.expander("â• ìƒˆ ì¼ì • ë“±ë¡í•˜ê¸° (í´ë¦­í•˜ì—¬ ì—´ê¸°)"):
    with st.form("add_task_form"):
        col1, col2, col3 = st.columns(3)
        with col1:
            new_project = st.text_input("í”„ë¡œì íŠ¸ëª… (ì˜ˆ: Aí”„ë¡œì íŠ¸)")
            new_item = st.text_input("í•­ëª© (ì˜ˆ: ê¸°íš)")
        with col2:
            new_member = st.text_input("ë‹´ë‹¹ì (ì˜ˆ: í™ê¸¸ë™)")
            new_activity = st.text_input("Activity (ì˜ˆ: í™”ë©´ì„¤ê³„)")
        with col3:
            new_start = st.date_input("ì‹œì‘ì¼", datetime.today())
            new_end = st.date_input("ì¢…ë£Œì¼", datetime.today())
        
        submitted = st.form_submit_button("ì¼ì • ì¶”ê°€")
        
        if submitted:
            # [ì¤‘ìš”] ì €ì¥í•  ë•ŒëŠ” ë‚ ì§œë¥¼ ë¬¸ìì—´(YYYY-MM-DD)ë¡œ ë³€í™˜í•´ì•¼ êµ¬ê¸€ ì‹œíŠ¸ ë‚ ì§œ í˜•ì‹ì´ ì•ˆ ê¹¨ì§‘ë‹ˆë‹¤.
            start_str = new_start.strftime("%Y-%m-%d")
            end_str = new_end.strftime("%Y-%m-%d")

            # ìƒˆë¡œìš´ í–‰ ìƒì„±
            new_row = pd.DataFrame([{
                "í”„ë¡œì íŠ¸ëª…": new_project,
                "í•­ëª©": new_item,
                "ë‹´ë‹¹ì": new_member,
                "Activity": new_activity,
                "ì‹œì‘ì¼": start_str,
                "ì¢…ë£Œì¼": end_str,
                "ì§„í–‰ë¥ ": 0
            }])
            
            # ê¸°ì¡´ ë°ì´í„°(data)ë„ ë‚ ì§œê°€ datetime ê°ì²´ì´ë¯€ë¡œ, ì €ì¥ìš©ìœ¼ë¡œ ë¬¸ìì—´ ë³€í™˜
            save_data = data.copy()
            save_data["ì‹œì‘ì¼"] = save_data["ì‹œì‘ì¼"].dt.strftime("%Y-%m-%d")
            save_data["ì¢…ë£Œì¼"] = save_data["ì¢…ë£Œì¼"].dt.strftime("%Y-%m-%d")
            
            # í•©ì¹˜ê¸°
            updated_df = pd.concat([save_data, new_row], ignore_index=True)
            
            # êµ¬ê¸€ ì‹œíŠ¸ì— ì—…ë°ì´íŠ¸
            conn.update(worksheet="Sheet1", data=updated_df)
            
            # [í•µì‹¬] ìºì‹œ ì‚­ì œí•˜ì—¬ ì¦‰ì‹œ ë°˜ì˜ë˜ê²Œ í•¨
            st.cache_data.clear()
            
            st.success("ìƒˆ ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! í™”ë©´ì´ ìƒˆë¡œê³ ì¹¨ ë©ë‹ˆë‹¤.")
            st.rerun()

# -----------------------------------------------------------------------------
# 5. [ì‹œê°í™” ì„¹ì…˜] ê°„íŠ¸ì°¨íŠ¸ (ì „ì²´ ì¼ì • ê³µìœ )
# -----------------------------------------------------------------------------
st.subheader("ğŸ“Š ì „ì²´ ì›”ë³„ ì¼ì • (Gantt Chart)")

if not view_data.empty:
    # Plotly Gantt Chart ìƒì„±
    fig = px.timeline(
        view_data, 
        x_start="ì‹œì‘ì¼", 
        x_end="ì¢…ë£Œì¼", 
        y="í”„ë¡œì íŠ¸ëª…", 
        color="ë‹´ë‹¹ì", 
        hover_data=["í•­ëª©", "Activity", "ì§„í–‰ë¥ "],
        text="Activity", # ë°” ìœ„ì— ê¸€ì”¨ í‘œì‹œ
        title="í”„ë¡œì íŠ¸ë³„ ì¼ì • ë°” ì°¨íŠ¸"
    )
    # ì°¨íŠ¸ ì •ë ¬ ë° UI ë‹¤ë“¬ê¸°
    fig.update_yaxes(autorange="reversed") # ìœ„ì—ì„œë¶€í„° ìˆœì„œëŒ€ë¡œ
    fig.update_layout(xaxis_title="ë‚ ì§œ", yaxis_title="í”„ë¡œì íŠ¸")
    
    st.plotly_chart(fig, use_container_width=True)
else:
    st.info("ë“±ë¡ëœ ì¼ì •ì´ ì—†ê±°ë‚˜ ë‚ ì§œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")

# -----------------------------------------------------------------------------
# 6. [ìˆ˜ì • ì„¹ì…˜] íŒ€ì›ë³„ ì§„í–‰ë¥  ì…ë ¥ (ë°ì´í„° ë™ê¸°í™”)
# -----------------------------------------------------------------------------
st.divider()
st.subheader("ğŸ“ íŒ€ì› ì—…ë¬´ í˜„í™© ë° ì§„í–‰ë¥  ì—…ë°ì´íŠ¸")
st.markdown("""
- ì•„ë˜ í‘œì—ì„œ ë³¸ì¸ì˜ **'ì§„í–‰ë¥ '** ì„ ì§ì ‘ ìˆ˜ì •í•˜ì„¸ìš”. (ìŠ¬ë¼ì´ë” ì¡°ì‘)
- ìˆ˜ì • í›„ í‘œ ì•„ë˜ì— ìƒê¸°ëŠ” **'ğŸ’¾ ë³€ê²½ì‚¬í•­ ì €ì¥'** ë²„íŠ¼ì„ ê¼­ ëˆŒëŸ¬ì•¼ ê³µìœ ë©ë‹ˆë‹¤.
""")

# ë°ì´í„° ì—ë””í„° (ë‚ ì§œ í¬ë§· ì§€ì •)
edited_df = st.data_editor(
    data,
    num_rows="dynamic",
    column_config={
        "ì§„í–‰ë¥ ": st.column_config.ProgressColumn(
            "ì§„í–‰ë¥  (%)",
            format="%d%%",
            min_value=0,
            max_value=100,
        ),
        "ì‹œì‘ì¼": st.column_config.DateColumn("ì‹œì‘ì¼", format="YYYY-MM-DD"),
        "ì¢…ë£Œì¼": st.column_config.DateColumn("ì¢…ë£Œì¼", format="YYYY-MM-DD"),
    },
    use_container_width=True,
    key="editor"
)

# -----------------------------------------------------------------------------
# 7. ì €ì¥ ë¡œì§
# -----------------------------------------------------------------------------
if st.button("ğŸ’¾ ë³€ê²½ì‚¬í•­ ì €ì¥ ë° íŒ€ì› ê³µìœ í•˜ê¸°", type="primary"):
    try:
        # [ì¤‘ìš”] ì €ì¥ ì „ ë‚ ì§œ í¬ë§·ì„ ë¬¸ìì—´(YYYY-MM-DD)ë¡œ í†µì¼
        save_df = edited_df.copy()
        save_df["ì‹œì‘ì¼"] = pd.to_datetime(save_df["ì‹œì‘ì¼"]).dt.strftime("%Y-%m-%d")
        save_df["ì¢…ë£Œì¼"] = pd.to_datetime(save_df["ì¢…ë£Œì¼"]).dt.strftime("%Y-%m-%d")
        
        # êµ¬ê¸€ ì‹œíŠ¸ì— ë®ì–´ì“°ê¸°
        conn.update(worksheet="Sheet1", data=save_df)
        
        # ìºì‹œ ì‚­ì œ (íŒ€ì›ë“¤ì—ê²Œ ì¦‰ì‹œ ë³´ì´ê²Œ í•˜ê¸° ìœ„í•´)
        st.cache_data.clear()
        
        st.toast("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!", icon="âœ…")
        st.rerun()
        
    except Exception as e:
        st.error(f"ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
