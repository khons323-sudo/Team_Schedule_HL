import streamlit as st
import pandas as pd
import plotly.express as px
from streamlit_gsheets import GSheetsConnection
from datetime import datetime

# -----------------------------------------------------------------------------
# 1. í˜ì´ì§€ ì„¤ì • ë° ì œëª©
# -----------------------------------------------------------------------------
st.set_page_config(page_title="ë””ìì¸1ë³¸ë¶€ ì¼ì •ê´€ë¦¬", layout="wide")
st.title("ğŸ“… ë””ìì¸1ë³¸ë¶€ 1íŒ€ ì‘ì—…ì¼ì •")

# -----------------------------------------------------------------------------
# 2. êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„° ì—°ê²° ë° ë¶ˆëŸ¬ì˜¤ê¸°
# -----------------------------------------------------------------------------
# êµ¬ê¸€ ì‹œíŠ¸ ì—°ê²° ê°ì²´ ìƒì„±
conn = st.connection("gsheets", type=GSheetsConnection)

# ë°ì´í„° ìºì‹± ì—†ì´ ë§¤ë²ˆ ìµœì‹  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë„ë¡ ttl=0 ì„¤ì • (ì‹¤ì‹œê°„ ê³µìœ  ì¤‘ìš”ì‹œ)
data = conn.read(worksheet="Sheet1", usecols=list(range(7)), ttl=0)

# ë¹ˆ ë°ì´í„°í”„ë ˆì„ ì²˜ë¦¬ (ë°ì´í„°ê°€ ì—†ì„ ê²½ìš°)
if len(data) == 0:
    data = pd.DataFrame(columns=["í”„ë¡œì íŠ¸ëª…", "í•­ëª©", "ë‹´ë‹¹ì", "Activity", "ì‹œì‘ì¼", "ì¢…ë£Œì¼", "ì§„í–‰ë¥ "])

# ë‚ ì§œ í˜•ì‹ ë³€í™˜ (ë¬¸ìì—´ -> ë‚ ì§œ ê°ì²´)
data["ì‹œì‘ì¼"] = pd.to_datetime(data["ì‹œì‘ì¼"])
data["ì¢…ë£Œì¼"] = pd.to_datetime(data["ì¢…ë£Œì¼"])

# -----------------------------------------------------------------------------
# 3. [ì…ë ¥ ì„¹ì…˜] ìƒˆë¡œìš´ ì—…ë¬´/ì¼ì • ë“±ë¡ (ê´€ë¦¬ì/íŒ€ì¥ìš©)
# -----------------------------------------------------------------------------
with st.expander("â• ìƒˆ ì¼ì • ë“±ë¡í•˜ê¸° (í´ë¦­í•˜ì—¬ ì—´ê¸°)"):
    with st.form("add_task_form"):
        col1, col2, col3 = st.columns(3)
        with col1:
            new_project = st.text_input("í”„ë¡œì íŠ¸ëª… (ì˜ˆ: a1)")
            new_item = st.text_input("í•­ëª© (ì˜ˆ: b1)")
        with col2:
            new_member = st.text_input("ë‹´ë‹¹ì (ì˜ˆ: ê¹€ì² ìˆ˜)")
            new_activity = st.text_input("Activity (ì˜ˆ: ë©”ì¸ ì‹œì•ˆ ë””ìì¸)")
        with col3:
            new_start = st.date_input("ì‹œì‘ì¼", datetime.today())
            new_end = st.date_input("ì¢…ë£Œì¼", datetime.today())
        
        # ì§„í–‰ë¥ ì€ ì²˜ìŒì—” 0%
        submitted = st.form_submit_button("ì¼ì • ì¶”ê°€")
        
        if submitted:
            # ìƒˆë¡œìš´ í–‰ ë°ì´í„° ìƒì„±
            new_row = pd.DataFrame([{
                "í”„ë¡œì íŠ¸ëª…": new_project,
                "í•­ëª©": new_item,
                "ë‹´ë‹¹ì": new_member,
                "Activity": new_activity,
                "ì‹œì‘ì¼": new_start.strftime("%Y-%m-%d"),
                "ì¢…ë£Œì¼": new_end.strftime("%Y-%m-%d"),
                "ì§„í–‰ë¥ ": 0
            }])
            
            # ê¸°ì¡´ ë°ì´í„°ì— ì¶”ê°€ í›„ êµ¬ê¸€ ì‹œíŠ¸ì— ì—…ë°ì´íŠ¸
            updated_df = pd.concat([data, new_row], ignore_index=True)
            conn.update(worksheet="Sheet1", data=updated_df)
            
            st.success("ìƒˆ ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! í™”ë©´ì´ ìƒˆë¡œê³ ì¹¨ ë©ë‹ˆë‹¤.")
            st.rerun()

# -----------------------------------------------------------------------------
# 4. [ì‹œê°í™” ì„¹ì…˜] ê°„íŠ¸ì°¨íŠ¸ (ì „ì²´ ì¼ì • ê³µìœ )
# -----------------------------------------------------------------------------
st.subheader("ğŸ“Š ì „ì²´ ì›”ë³„ ì¼ì • (Gantt Chart)")

if not data.empty:
    # Plotly Gantt Chart ìƒì„±
    fig = px.timeline(
        data, 
        x_start="ì‹œì‘ì¼", 
        x_end="ì¢…ë£Œì¼", 
        y="í”„ë¡œì íŠ¸ëª…", 
        color="æ‹…å½“ì", # ë‹´ë‹¹ìë³„ë¡œ ìƒ‰ìƒ êµ¬ë¶„ (í˜¹ì€ í”„ë¡œì íŠ¸ëª…ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥)
        hover_data=["í•­ëª©", "Activity", "ì§„í–‰ë¥ "],
        title="í”„ë¡œì íŠ¸ë³„ ì¼ì • ë°” ì°¨íŠ¸"
    )
    # ì°¨íŠ¸ ì •ë ¬ ë° UI ë‹¤ë“¬ê¸°
    fig.update_yaxes(autorange="reversed") # ìœ„ì—ì„œë¶€í„° ìˆœì„œëŒ€ë¡œ
    fig.update_layout(xaxis_title="ë‚ ì§œ", yaxis_title="í”„ë¡œì íŠ¸")
    
    st.plotly_chart(fig, use_container_width=True)
else:
    st.info("ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì¼ì •ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.")

# -----------------------------------------------------------------------------
# 5. [ìˆ˜ì • ì„¹ì…˜] íŒ€ì›ë³„ ì§„í–‰ë¥  ì…ë ¥ (ë°ì´í„° ë™ê¸°í™”)
# -----------------------------------------------------------------------------
st.divider()
st.subheader("ğŸ“ íŒ€ì› ì—…ë¬´ í˜„í™© ë° ì§„í–‰ë¥  ì—…ë°ì´íŠ¸")
st.markdown("""
- ì•„ë˜ í‘œì—ì„œ ë³¸ì¸ì˜ **'ì§„í–‰ë¥ '** ì„ ì§ì ‘ ìˆ˜ì •í•˜ì„¸ìš”.
- ìˆ˜ì • í›„ ì—”í„°ë¥¼ ì¹˜ë©´ **'ë³€ê²½ì‚¬í•­ ì €ì¥'** ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤. ê¼­ ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ê³µìœ ë©ë‹ˆë‹¤.
""")

# ë°ì´í„° ì—ë””í„° (ì—‘ì…€ì²˜ëŸ¼ ìˆ˜ì • ê°€ëŠ¥í•˜ê²Œ í•¨)
# í‚¤ ì»¬ëŸ¼ë“¤ì€ ìˆ˜ì •ì„ ë§‰ê³ , ì§„í–‰ë¥ ë§Œ ìˆ˜ì • ê°€ëŠ¥í•˜ê²Œ ì„¤ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
edited_df = st.data_editor(
    data,
    num_rows="dynamic",  # í–‰ ì¶”ê°€/ì‚­ì œ ê°€ëŠ¥ ì—¬ë¶€
    column_config={
        "ì§„í–‰ë¥ ": st.column_config.ProgressColumn(
            "ì§„í–‰ë¥  (%)",
            help="ì‘ì—… ì§„í–‰ ìƒí™©ì„ í¼ì„¼íŠ¸ë¡œ ì…ë ¥í•˜ì„¸ìš”",
            format="%d%%",
            min_value=0,
            max_value=100,
        ),
        "ì‹œì‘ì¼": st.column_config.DateColumn("ì‹œì‘ì¼", format="YYYY-MM-DD"),
        "ì¢…ë£Œì¼": st.column_config.DateColumn("ì¢…ë£Œì¼", format="YYYY-MM-DD"),
    },
    use_container_width=True,
    key="editor"
)

# -----------------------------------------------------------------------------
# 6. ì €ì¥ ë¡œì§
# -----------------------------------------------------------------------------
# ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
if not data.equals(edited_df):
    if st.button("ğŸ’¾ ë³€ê²½ì‚¬í•­ ì €ì¥ ë° íŒ€ì› ê³µìœ í•˜ê¸°", type="primary"):
        # ë‚ ì§œ í¬ë§·ì„ ë¬¸ìì—´ë¡œ í†µì¼í•˜ì—¬ ì €ì¥ (êµ¬ê¸€ ì‹œíŠ¸ ì˜¤ë¥˜ ë°©ì§€)
        edited_df["ì‹œì‘ì¼"] = pd.to_datetime(edited_df["ì‹œì‘ì¼"]).dt.strftime("%Y-%m-%d")
        edited_df["ì¢…ë£Œì¼"] = pd.to_datetime(edited_df["ì¢…ë£Œì¼"]).dt.strftime("%Y-%m-%d")
        
        # êµ¬ê¸€ ì‹œíŠ¸ì— ë®ì–´ì“°ê¸°
        conn.update(worksheet="Sheet1", data=edited_df)
        
        st.toast("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!", icon="âœ…")
        st.rerun()
